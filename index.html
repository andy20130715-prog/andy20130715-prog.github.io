<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¥åº·é¢¨éšªæç¤º</title>
  <style>
    body { font-family: "PingFang HK", sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { color: #2c6fbb; }
    #result { margin-top: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .loading { color: #666; }
  </style>
</head>
<body>
  <p>  ç¶²é å·²è¼‰å…¥ </p>
  <h2>ğŸ“ æ­£åœ¨å–å¾—æ‚¨çš„ä½ç½®...</h2>
  <div id="result" class="loading">è«‹å…è¨±ä½ç½®æ¬Šé™ä»¥ç²å–é™„è¿‘å¥åº·é¢¨éšªæç¤ºã€‚</div>

  <script>
    // ğŸ“Œ ç¬¬ä¸€æ­¥ï¼šå…ˆå®šç¾©è¦ç”¨çš„å‡½æ•¸
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/1mpwYy1yPcl_URhK1_1056P69OCJCVhyuVN10VUG0EN8/export?format=csv";

    // å‡è¨­ä½ çš„ Google Sheet æœ‰é€™äº›æ¬„ä½ï¼šlatitude, longitude, district, risk_level
    function showRiskForLocation(userLat, userLng) {
      document.getElementById("result").innerHTML = "æ­£åœ¨è¼‰å…¥å€åŸŸè³‡æ–™...";
      
      fetch(SHEET_CSV_URL)
        .then(response => {
          if (!response.ok) throw new Error("ç„¡æ³•è¼‰å…¥è³‡æ–™");
          return response.text();
        })
        .then(csvText => {
          const lines = csvText.trim().split('\n');
          const headers = lines[0].split(',').map(h => h.trim());
          const latIdx = headers.indexOf('latitude');
          const lngIdx = headers.indexOf('longitude');
          const districtIdx = headers.indexOf('district'); // âš ï¸ è«‹ç¢ºèªä½ çš„ Google Sheet æ¬„ä½åç¨±æ˜¯ 'district'
          const riskIdx = headers.indexOf('risk_level');  // âš ï¸ åŒæ¨£ç¢ºèªé¢¨éšªç­‰ç´šæ¬„ä½å

          // ç°¡å–®æ‰¾æœ€è¿‘çš„å€ï¼ˆå¯¦éš›æ‡‰ç”¨å»ºè­°ç”¨ GIS å¤šé‚Šå½¢åˆ¤æ–·ï¼Œä½†é€™è£¡å…ˆç”¨æœ€è¿‘é»ï¼‰
          let nearestDistrict = null;
          let minDistance = Infinity;

          for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(',');
            const lat = parseFloat(row[latIdx]);
            const lng = parseFloat(row[lngIdx]);
            const district = row[districtIdx];

            if (isNaN(lat) || isNaN(lng)) continue;

            const distance = Math.sqrt(
              Math.pow(userLat - lat, 2) + Math.pow(userLng - lng, 2)
            );

            if (distance < minDistance) {
              minDistance = distance;
              nearestDistrict = {
                name: district,
                risk: row[riskIdx]
              };
            }
          }

          if (nearestDistrict) {
            let riskColor = "#4CAF50"; // green
            if (nearestDistrict.risk === "3") riskColor = "#FF9800"; // orange
            if (nearestDistrict.risk === "4") riskColor = "#F44336"; // red

            document.getElementById("result").innerHTML = `
              <h3>æ‚¨ä½æ–¼ï¼š${nearestDistrict.name}</h3>
              <p>å¥åº·é¢¨éšªç­‰ç´šï¼š<span style="color:${riskColor}; font-weight:bold;">
                ${nearestDistrict.risk}
              </span></p >
              <p>å»ºè­°ï¼šæ³¨æ„ä¿æš–ã€æ¸›å°‘å¤–å‡ºã€ä¿æŒå®¤å…§é€šé¢¨ã€‚</p >
            `;
          } else {
            document.getElementById("result").innerHTML = "æ‰¾ä¸åˆ°å°æ‡‰çš„è¡Œæ”¿å€è³‡æ–™ã€‚";
          }
        })
        .catch(err => {
          console.error("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼š", err);
          document.getElementById("result").innerHTML = "âš ï¸ ç„¡æ³•è¼‰å…¥é¢¨éšªè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        });
    }

    // ğŸ“Œ ç¬¬äºŒæ­¥ï¼šå†åŸ·è¡Œå®šä½
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          console.log("å®šä½æˆåŠŸï¼š", lat, lng);
          showRiskForLocation(lat, lng);
        },
        (err) => {
          console.error("å®šä½å¤±æ•—ï¼š", err);
          let msg = "è«‹å…è¨±ä½ç½®æ¬Šé™ä»¥ç²å–é™„è¿‘å¥åº·é¢¨éšªæç¤ºã€‚";
          if (err.code === 1) msg += "<br>ï¼ˆè«‹é»æ“Šç¶²å€åˆ—å·¦å´ã€ŒğŸ”’ã€â†’ é–‹å•Ÿã€Œä½ç½®ã€ï¼‰";
          document.getElementById("result").innerHTML = msg;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    } else {
      document.getElementById("result").innerHTML = "æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚";
    }
  </script>
</body>
</html>